# QuickBattle

## 一、游戏核心定位与设计原则

### 1. 核心定位

- 类型：**8人内实时竞技对战**（支持 PC / 移动端跨平台）；

- 核心玩法：玩家操控简易角色，在小型地图中完成 “收集资源 + 释放技能 + 击败对手” 的循环，单局时长5分钟；

- 设计目标：以 “最小化玩法复杂度” 覆盖需要验证的三大网络场景，同时产生多样化的 Netcode 数据流（NetworkVariable/Rpc/NetworkEvent）。

### 2. 关键设计原则

| 设计原则       | 具体要求                                                     | 适配的优化验证点                |
| -------------- | ------------------------------------------------------------ | ------------------------------- |
| 数据流全覆盖   | 包含了高 / 中 / 低优先级数据，同时触发可靠 / 不可靠传输需求  | 多路复用（流映射 + 优先级调度） |
| 连接场景全面化 | 首次连接 + 重连 + 网络切换                                   | 0-RTT 快速连接、连接迁移        |
| 开发轻量化     | 角色 / 地图 / 技能均采用极简设计，无需美术资源投入           | 聚焦传输层优化，降低开发成本    |
| 可测试性强     | 支持自定义网络参数（延迟 / 丢包率），内置性能统计面板（延迟 / 丢包 / 流状态） | 快速验证优化效果，生成实验数据  |



## 二、游戏核心功能设计（仅保留验证所需模块）

### 1. 基础玩法模块（极简实现）

- **角色系统**：

  操控：WASD 移动（PC）/ 虚拟摇杆（移动端），鼠标 / 触摸点击释放技能；

  状态：位置（Vector3）、血量（int）、能量值（int）、等级（int）、分数（int）、技能 CD（float），均通过NetworkVariable同步；

  表现：使用 Unity 内置胶囊体 / 方块模型，颜色区分不同玩家（无需动画）。

  机制补充：初始100血量，每提升50分数玩家升一级（视觉表现为能量值）

- **技能系统**：

  技能类型：3 个基础技能（无需特效）：

1. 攻击技能（高优先级 RPC）：造成30伤害，cd1s，需100%可靠传输，优先级0

1. 回血技能（中高优先级 RPC）：恢复50血量，cd10s，需可靠传输，优先级1；

1. 加速技能（中优先级 RPC）：3s内提升100%移动速度，cd15s，允许少量延迟，优先级2

   释放逻辑：技能 CD 通过NetworkVariable同步，释放指令通过Rpc发送。

- **资源系统**：

  地图中随机生成 “能量包”（静态模型），玩家触碰后收集（触发NetworkEvent）；

  收集后能量值和分数增加（NetworkVariable同步），能量值到达一定值后玩家提升等级。

- **对战规则**：

  分数计算：1个能量块5分，击败玩家可以偷取其50%分数

  排行榜：实时更新，1秒更新一次，根据分数进行排名



有余力可以做：

1. 通缉：排行榜第一名的玩家会暴露位置



### 2. 网络场景触发模块（核心验证载体）

| 网络场景     | 游戏内触发方式                                               | 验证的优化点                             |
| ------------ | ------------------------------------------------------------ | ---------------------------------------- |
| 首次连接     | 游戏启动后点击 “加入房间”，连接云服务器                      | MSQUIC 1-RTT 连接延迟                    |
| 0-RTT 重连   | 游戏中主动断连，或模拟网络中断后自动重连                     | 0-RTT 重连延迟、早期数据（玩家状态）传输 |
| 网络切换     | 移动端实机测试时，手动切换 Wi-Fi/5G；PC 端通过路由切换模拟   | 连接迁移（中断时长、数据丢失率）         |
| 多流并发传输 | 8 人同时释放技能 + 移动 + 聊天，排行榜实时更新               | 多路复用（优先级调度、无队头阻塞）       |
| 弱网环境     | 游戏内内置 “弱网模拟开关”（调用Clumsy工具设置丢包率 10%-30%、延迟 100ms） | 多路复用 + 连接迁移的弱网适应性          |



### 3. 实验数据统计模块（内置面板）

在游戏 UI 中添加 “传输性能统计面板”，实时显示关键指标（用于实验数据记录）：

- 连接相关：当前连接方式（1-RTT/0-RTT）、连接延迟（ms）、重连次数；

- 传输相关：各流类型延迟（RPC/NetworkVariable/ 聊天）、丢包率（%）、带宽占用（KB/s）；

- 迁移相关：网络切换次数、迁移中断时长（ms）、迁移后数据补发数量；

- 统计逻辑：数据每 100ms 采样一次，自动保存至本地 CSV 文件（便于后续分析）。



## 三、游戏数据流与 MSQUIC 传输映射（精准匹配优化方案）

游戏内所有数据均按以下规则映射至 QUIC 传输通道（stream）：

| 游戏数据类型                       | Netcode 实现方式        | 优先级（越小越高） | 可靠性要求   | MSQUIC 传输方式         | 验证目标                     |
| ---------------------------------- | ----------------------- | ------------------ | ------------ | ----------------------- | ---------------------------- |
| 技能释放指令（攻击 / 加速 / 回血） | ServerRpc（服务器权威） | 0                  | 100% 送达    | 可靠双向流（0x1000 起） | 多路复用中高优先级流无阻塞   |
| 玩家位置 / 血量 / 能量值同步       | NetworkVariable         | 10                 | 允许少量丢失 | 不可靠数据报（0x0001）  | 低延迟状态同步（≤50ms）      |
| 排行榜                             | ClientRpc（广播）       | 20                 | 基本可靠     |                         |                              |
| 聊天信息（玩家文字交流）           | ClientRpc（广播）       | 30                 | 基本可靠     | 可靠单向流（0x2000 起） | 低优先级流不挤占核心数据带宽 |



## 四、开发与测试规划（适配毕设时间线）

### 1. 开发阶段（按模块拆分，4-6 周可完成）

12.16开始，目标4月前完成测试游戏开发+实验数据分析+论文撰写

| 阶段                | 核心任务                                                     | 产出物                         |
| ------------------- | ------------------------------------------------------------ | ------------------------------ |
| 12.16-12.25（10天） | 基础玩法开发（角色操控、技能释放、资源收集）                 | 可单机运行的游戏原型           |
| 12.26-12.30（5天）  | Netcode集成，实现基础开发中未实现的功能（排行榜等）          | 初步联机版本                   |
| 12.31-1.14（15天）  | 自定义 MSQUIC 传输层集成（多路复用 + 0-RTT + 连接迁移）+ 数据流映射**（1.7-1.15 期末复习会耽误）** | 支持 MSQUIC 传输的多人游戏版本 |
| 1.15-1.24（10天）   | 实验数据统计UI开发，弱网模拟功能集成（调用 Clumsy 工具 / Unity 网络 API） | 带统计功能的实验版游戏         |
| 1.25-1.31（1周）    | 跨平台适配（PC→移动端）+ 服务器部署（云服务器 2 核 4G），一些收尾工作 | 支持 PC / 移动端的可测试版本   |
| 多余时间            | 实现一些其他游戏性功能，比如更换模型，增加特效，增加音乐，美化UI等等 | 润色游戏，增加可游玩性         |



### 2. 测试场景设计（对应三大优化目标）

| 优化目标       | 测试场景                                                     | 测试方法与工具                                            |
| -------------- | ------------------------------------------------------------ | --------------------------------------------------------- |
| 多路复用性能   | 8 人同时游戏：每人每秒释放 2 次技能 + 持续移动 + 发送 1 条聊天信息 | Wireshark 抓包分析各流延迟 / 带宽；游戏内统计面板记录数据 |
| 0-RTT 快速连接 | 1. 首次连接 10 次，记录平均延迟；2. 重连 10 次（主动断开 + 网络中断），记录 0-RTT 延迟 | 自定义延迟统计工具（记录连接完成时间）                    |
| 连接迁移稳定性 | 1. 移动端 Wi-Fi→5G 切换 10 次；2. PC 端路由切换模拟网络切换 10 次 | 记录迁移中断时长、数据丢失率；观察游戏是否卡顿 / 瞬移     |
| 弱网适应性     | 丢包率 10%/20%/30%、延迟 50ms/100ms/150ms 的组合场景测试     | Clumsy工具模拟弱网；游戏内观察状态同步平滑度              |



### 3. 预期实验结果（用于毕设论文数据分析）

- 多路复用：高优先级技能指令延迟≤30ms，聊天流与技能流带宽隔离度≥90%；

- 0-RTT 连接：重连延迟≤50ms（比 Netcode 默认 TCP 重连快 75%+）；

- 连接迁移：网络切换中断时长≤100ms，技能指令丢失率≤1%，无明显卡顿 / 瞬移；

- 弱网环境（30% 丢包）：玩家位置同步平滑，技能释放无明显延迟。





## 开发阶段日记

Day1 12.16

Player.cs 玩家类框架

GameInput.cs 结合新输入系统的输入类



12.17 什么也没做



12.18

完善玩家跳跃功能

**跳跃逻辑：**玩家点击跳跃键 -> 判断是否能跳跃？（isGround） -> 是否跳跃（给一个竖直方向初速度）

移动和跳跃改用刚体实现

子弹类 玩家可以发射子弹 攻击其他玩家

实现玩家攻击、加速、回血的技能



12.19

开始制作游戏流程 GameManager.cs

完善第三人称相机

制作游戏界面的主UI MainUI.cs

包含哪些元素？

1. 计时器（游戏剩余时间）
2. 当前得分 当前击杀数
3. 能量条 玩家等级 血量等属性，玩家状态UI，PlayerStateUI.cs
4. 设置按钮 设置子UI SettingUI.cs
5. 排行榜子UI RankUI.cs
6. （移动端）输入子UI PlayerInputUI.cs（摇杆、技能）
7. （PC端）技能cd子UI SkliiCoolDownUI.cs
8. 结算界面子UI GameOverUI.cs

补充：玩家增加姓名属性 name



12.20 摆

12.21 摆



12.22

接口抽象 把所有能被攻击的对象都实现IDamagable接口（亮血条）

初步处理死亡逻辑

玩家增加分数，击杀数属性



12.23

资源生成算法

目标：地图中随机生成能量块，玩家拾取后可以增加积分，现在要实现生成算法

ResourceManager.cs

算法流程：

1. 划分随机生成的区域，要生成的数量，在游戏开始时执行一次算法

   区域：记录2个顶点（左上右下）信息（Vector3，y = 0f），生成时判断是否在此范围内

2. 生成之前进行检测：如果附近一定范围内有资源，则重新生成

3. 玩家拾取资源后，进行补充，重新生成资源



对象池 PoolManager.cs

意图：减少GC，增加资源重复利用率

流程：

1. 初始化，CreatePool()：不同对象有着不同的对象池队列（ObjectPoolQueue），所有队列使用一个字典统一管理（Dictionary<int, Queue\<Component>>）
2. 取出对象逻辑，ReuseComponent()：在某个队列中，取出（出队）第一个可以使用的对象（active == false），然后将该对象再次入队。
   对象池的动态扩容：如果没有可以使用的对象，则增加该队列的容量（实验所用版本未实现动态扩容 简单起见）



问题：游戏卡顿 FPS有点低，先不管优化了。。。。。。





12.24

GameManager.cs 和 QuickNetworkManager.cs区别

前者：

1. 处理游戏状态（PlayingState、GameOverState等等）
2. 管理游戏规则
3. 处理游戏数据（本地玩家得分等等，比如排行榜UI获取得分就要通过GameManager）

后者：

1. 管理网络连接（连接 / 断开）
2. 玩家的网络注册 / 注销
3. 同步网络状态（如玩家加入 / 离开）



12.25 圣诞快乐~ 开始收尾工作

简单地编，搭建一下环境

完善一下游戏UI

制作主菜单UI，大厅UI

最后，把完成的单机版本上传到Github，准备联机部分的开发



优化：

1. 相机优化 表现更加流畅
2. 资源生成逻辑优化：能量块不会生成在地面或者模型里



12.26 拼UI

12.27

接着拼UI 技能UI

netcode开始集成



玩家角色创建（基本属性、移动和跳跃逻辑、技能逻辑）

PC、移动跨平台

基本场景和UI搭建（主界面、大厅界面、战斗界面）

游戏流程实现（玩家生成、获取分数、击杀玩家、倒计时、结算界面）

地编

资源生成算法、资源拾取逻辑、玩家等级逻辑

排行榜UI

聊天系统

大厅管理 LobbyManager.cs



QUIC和网络相关：

MsQuicNative.cs：调用msquic的原生接口

QuicTransport.cs：自定义quic传输层



实验测试：

指标分析工具

哪些指标？

多路复用：wireshark抓包分析流延迟

0-RTT：记录首次连接、断网重连延迟

连接迁移：游戏中断时长、丢包率